@using Microsoft.AspNetCore.Identity
@using VZTest.Models.Test
@inject SignInManager<IdentityUser> signInManager
@model TestPriviewModel
@{
    ViewData["Title"] = "Предпросмотр теста";
}

@if (!signInManager.IsSignedIn(User))
{
    <h5>Войдите в свой аккаунт!</h5>
    return;
}

@if (Model == null || Model.Forbidden)
{
    <h5>Доступ к опросу закрыт!</h5>
    return;
}

@if (Model.NotFound)
{
    <h5>Такой тест не найден!</h5>
    return;
}

<script>
    function StarToggle(id)
    {
        var verificationValue = document.getElementsByName('__RequestVerificationToken')[0].getAttribute('value');
        var starred = document.getElementById("star-toggle-"+id) == null;
        $.ajax({
                type: "POST",
                url: "/Test/StarToggle/",
                data: {id: id, starred: starred, __RequestVerificationToken: verificationValue },
                success: function(data)
                {
                    if (starred)
                    {
                        var element = document.getElementById("unstar-toggle-"+id);
                        element.innerHTML = "<small>" + data + " <i class=\"bi bi-star\"></i></small>";
                        element.setAttribute('id', "star-toggle-"+id);
                    }
                    else
                    {
                        var element = document.getElementById("star-toggle-"+id);
                        element.innerHTML = "<small>" + data + " <i class=\"bi bi-star-fill\"></i></small>";
                        element.setAttribute('id', "unstar-toggle-"+id);
                    }
                }});
    }
</script>

<style>
h2 {
  display:inline-block;
  float:left;
}
</style>
    <h2><i class="bi bi-list-check"></i> Информация об опросе #@Model.Test.Id</h2>
<div class="pull-left">  
    @if (Model.Liked)
    {
        <a id="unstar-toggle-@Model.Test.Id" class="btn btn-outline-success mx-3" onclick="StarToggle(@Model.Test.Id);"><small>@Model.StarsCount <i class="bi bi-star-fill"></i></small></a>
    }
    else
    {
        <a id="star-toggle-@Model.Test.Id" class="btn btn-outline-success mx-3" onclick="StarToggle(@Model.Test.Id);"><small>@Model.StarsCount <i class="bi bi-star"></i></small></a>
    }
</div>
<hr>
<span style="white-space: pre-line">Название: <b>@Model.Test.Title</b>
    Описание: <b>@Model.Test.Description</b>
    Максимальное количество попыток: <b>@Model.Test.MaxAttempts</b>
</span>
<span style="white-space: pre-line">Был пройден пользователями платформы <b>@Model.TotalAttempts @WordHelp.Inflect(Model.TotalAttempts,"раз","раз","раза")</b></span>
<hr>
@if (Model.UserAttempts.Count() > 0)
{
    <h5>Ваши попытки:</h5>
    @foreach (Attempt attempt in Model.UserAttempts)
    {
        if (attempt.Active)
        {
            <a asp-controller="Test" asp-action="Attempt" asp-route-id="@attempt.Id">[Активная] Попытка от @attempt.TimeStarted.ToString("dd.MM.yyyy HH:mm:ss")</a>
        }
        else
        {
            <a asp-controller="Test" asp-action="Attempt" asp-route-id="@attempt.Id">[Завершена] Попытка от @attempt.TimeStarted.ToString("dd.MM.yyyy HH:mm:ss")</a>
        }
        <hr>
    }
}
@if (Model.Test.MaxAttempts > Model.UserAttempts.Count())
{
    <form method="post">
        <button class="btn btn-outline-primary" type="submit"><i class="bi bi-check2"></i> Пройти</button>
    </form>
}
else
{
    <h5>Вы исчерпали все попытки в этом тесте</h5>
}